openapi: 3.0.0
info:
  contact: { }
  description: KubeVirt Service Provider API
  title: KubeVirt Service Provider API
  version: v1alpha1
  license:
    name: Apache 2.0
    url: https://www.apache.org/licenses/LICENSE-2.0.html

servers:
  - url: /

tags:
  - name: health
    description: Health check endpoints

paths:
  /health:
    get:
      summary: Health check
      operationId: listHealth
      description: Health check for KubeVirt Service Provider API
      tags:
        - health
      responses:
        '200':
          description: OK
          content:
            text/plain:
              schema:
                type: string
                example: "ok"

  /api/v1/vm/health:
    get:
      summary: Health check
      operationId: listVmHealth
      description: Health check for VM service type
      tags:
        - health
      responses:
        '200':
          description: OK
          content:
            text/plain:
              schema:
                type: string
                example: "ok"

  /api/v1/vm:
    get:
      summary: List virtual machine applications
      operationId: listVms
      description: List all virtual machine applications
      parameters:
        - name: max_page_size
          in: query
          description: Maximum number of results to return per page
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 1000
            default: 100
        - name: page_token
          in: query
          description: Token for pagination
          required: false
          schema:
            type: string
        - name: id
          in: query
          description: Filter by request ID (UUID)
          required: false
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                required:
                  - vms
                properties:
                  vms:
                    type: array
                    items:
                      $ref: '#/components/schemas/VMInstance'
                  next_page_token:
                    type: string
                    description: Token for the next page of results
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    post:
      summary: Create a VM
      operationId: createVm
      description: Create a virtual machine application
      parameters:
        - name: id
          in: query
          description: Optional request ID (UUID). If not provided, one will be generated.
          required: false
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/VMSpec'
      responses:
        '201':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VM'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/v1/vm/{vmId}:
    get:
      summary: Get virtual machine applications
      operationId: getVm
      description: Get a virtual machine applications.
      parameters:
        - name: vmId
          in: path
          required: true
          schema:
            type: string
            format: uuid
            example: "123e4567-e89b-12d3-a456-426614174000"
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/VMInstance'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
    delete:
      summary: Delete a virtual machine
      operationId: deleteVm
      description: Delete a virtual machine instance
      parameters:
        - name: vmId
          in: path
          required: true
          schema:
            type: string
            format: uuid
            example: "123e4567-e89b-12d3-a456-426614174000"
      responses:
        '204':
          description: No Content
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
components:
  schemas:
    VMSpec:
      x-aep-resource: true
      type: object
      description: |
        Provider-agnostic virtual machine specification.
        
        This schema is based on industry standards (OVF, CIM) and represents
        compute, memory, storage, and network requirements that can be fulfilled
        by various providers (KubeVirt, VMware vSphere, OpenStack, AWS, Azure,
        Google Cloud, etc.).
        
        Providers translate this abstract specification to their native format.
        
        Note: This schema does not define required fields. Instead, each
        CatalogItem that references this schema can define its own validation
        rules, allowing different catalog items to have different requirements.
      properties:
        path:
          type: string
          description: Resource path for this VM specification
          example: "/api/v1/vm"
        # ======================================================================
        # Schema Version
        # ======================================================================
        schemaVersion:
          type: string
          description: |
            Schema version identifier for this specification.
            
            Format: v<major><stability><minor>
            - major: Schema major version (e.g., v1, v2)
            - stability: alpha, beta, or omitted for stable
            - minor: Minor version number
            
            Examples: v1alpha1, v1beta1, v1, v2alpha1
            
            This field enables schema evolution while maintaining backward
            compatibility. Providers can support multiple schema versions
            simultaneously during transitions.
          pattern: "^v[0-9]+(alpha|beta)?[0-9]*$"
          default: "v1alpha1"
          example: "v1alpha1"
        # ======================================================================
        # Compute Resources
        # Based on: OVF VirtualHardwareSection, CIM CIM_Processor
        # ======================================================================
        compute:
          type: object
          description: |
            Compute resource requirements.
            Aligns with OVF VirtualHardwareSection for CPU configuration.
          properties:
            vcpu:
              type: object
              description: Virtual CPU configuration
              required:
                - count
              properties:
                count:
                  type: integer
                  description: |
                    Number of virtual CPUs.
                    Maps to: vCPU count in all providers.
                  default: 2
                  minimum: 1
                  maximum: 256
                  example: 4

                sockets:
                  type: integer
                  description: |
                    Number of CPU sockets (optional).
                    Affects NUMA topology and software licensing.
                    Default: derive from vCPU count.
                  minimum: 1
                  maximum: 16
                  example: 2

                coresPerSocket:
                  type: integer
                  description: |
                    Cores per socket (optional).
                    Used for specific CPU topology requirements.
                  minimum: 1
                  maximum: 64
                  example: 2

                threads:
                  type: integer
                  description: |
                    Threads per core (optional).
                    1 = hyperthreading disabled, 2 = enabled.
                  enum: [ 1, 2 ]
                  default: 1

                shares:
                  type: integer
                  description: |
                    CPU shares for resource scheduling (optional).
                    Higher values = higher priority.
                    Based on VMware/OpenStack CPU shares concept.
                  minimum: 0
                  maximum: 1000000
                  example: 2000

                reservation:
                  type: integer
                  description: |
                    Minimum guaranteed CPU in MHz (optional).
                    Based on VMware CPU reservation.
                  minimum: 0
                  example: 1000

                limit:
                  type: integer
                  description: |
                    Maximum CPU in MHz (optional).
                    Based on VMware CPU limit.
                  minimum: 0
                  example: 4000

            memory:
              type: object
              description: Memory configuration (RAM)
              required:
                - sizeGB
              properties:
                sizeGB:
                  type: integer
                  description: |
                    Memory size in gigabytes.
                    Maps to: guest.memory in all providers.
                  default: 4
                  minimum: 1
                  maximum: 4096
                  example: 16

                shares:
                  type: integer
                  description: |
                    Memory shares for resource scheduling (optional).
                    Higher values = higher priority.
                  minimum: 0
                  maximum: 1000000
                  example: 10240

                reservation:
                  type: integer
                  description: |
                    Minimum guaranteed memory in GB (optional).
                  minimum: 0
                  example: 8

                limit:
                  type: integer
                  description: |
                    Maximum memory in GB (optional).
                  minimum: 0
                  example: 32
        # ======================================================================
        # Storage Configuration
        # Based on: OVF DiskSection, CIM CIM_StorageExtent
        # ======================================================================
        storage:
          type: object
          description: |
            Storage configuration.
            Based on OVF DiskSection for virtual disk specifications.
          required:
            - disks
          properties:
            disks:
              type: array
              description: |
                Virtual disk specifications.
                Minimum one disk required (boot disk).
              minItems: 1
              items:
                type: object
                required:
                  - name
                  - capacityGB
                properties:
                  name:
                    type: string
                    description: |
                      Disk identifier (unique within VM).
                      Convention: "boot", "data", "log", etc.
                    pattern: "^[a-z0-9]([a-z0-9-]*[a-z0-9])?$"
                    example: "boot"

                  capacityGB:
                    type: integer
                    description: Disk capacity in gigabytes
                    minimum: 1
                    maximum: 65536
                    example: 100

                  format:
                    type: string
                    description: |
                      Disk format (optional, provider-specific).
                      - thin: Dynamically allocated
                      - thick: Pre-allocated (lazy-zeroed)
                      - thick-eager: Pre-allocated (eager-zeroed)
                    enum: [ "thin", "thick", "thick-eager" ]
                    default: "thin"

                  bus:
                    type: string
                    description: |
                      Disk bus/controller type (optional).
                      Provider selects optimal default if not specified.
                    enum: [ "virtio", "scsi", "sata", "ide", "nvme" ]
                    example: "virtio"

                  storageProfile:
                    type: string
                    description: |
                      Storage profile/class (provider-specific).
                      Examples: "ssd", "nvme", "standard", "premium"
                    example: "ssd"

                  bootOrder:
                    type: integer
                    description: |
                      Boot priority (1 = primary boot device).
                      Only specify for bootable disks.
                    minimum: 1
                    maximum: 16
                    example: 1
        # ======================================================================
        # Network Configuration
        # Based on: OVF NetworkSection, CIM CIM_NetworkAdapter
        # ======================================================================
        network:
          type: object
          description: |
            Network configuration.
            Based on OVF NetworkSection for network interface specifications.
          properties:
            interfaces:
              type: array
              description: Virtual network interface specifications
              default:
                - name: "eth0"
                  model: "virtio"
              items:
                type: object
                required:
                  - name
                properties:
                  name:
                    type: string
                    description: Interface name/identifier
                    pattern: "^[a-z0-9]([a-z0-9-]*[a-z0-9])?$"
                    example: "eth0"

                  model:
                    type: string
                    description: |
                      Network adapter model (optional).
                      Provider selects optimal default if not specified.
                      - virtio: Paravirtualized (best performance)
                      - e1000/e1000e: Intel emulation (broad compatibility)
                      - vmxnet3: VMware paravirtualized
                    enum: [ "virtio", "e1000", "e1000e", "vmxnet3", "rtl8139" ]
                    default: "virtio"

                  network:
                    type: string
                    description: |
                      Network name/identifier (provider-specific).
                      Examples: "default", "dmz", "internal", "external"
                    default: "default"
                    example: "internal"

                  ipam:
                    type: object
                    description: IP address management configuration
                    properties:
                      mode:
                        type: string
                        description: IP address allocation mode
                        enum: [ "dhcp", "static", "none" ]
                        default: "dhcp"

                      staticIPv4:
                        type: string
                        description: Static IPv4 address (CIDR notation)
                        pattern: "^([0-9]{1,3}\\.){3}[0-9]{1,3}/[0-9]{1,2}$"
                        example: "192.168.1.100/24"

                      gateway:
                        type: string
                        description: Default gateway (for static IP)
                        pattern: "^([0-9]{1,3}\\.){3}[0-9]{1,3}$"
                        example: "192.168.1.1"

                      dns:
                        type: array
                        description: DNS servers (for static IP)
                        items:
                          type: string
                          pattern: "^([0-9]{1,3}\\.){3}[0-9]{1,3}$"
                        example: [ "8.8.8.8", "8.8.4.4" ]
        # ======================================================================
        # Operating System & Firmware
        # Based on: OVF OperatingSystemSection
        # ======================================================================
        guestOS:
          type: object
          description: |
            Guest operating system configuration.
            Based on OVF OperatingSystemSection.
          required:
            - type
          properties:
            type:
              type: string
              description: |
                Operating system identifier (provider-specific).
                
                Naming convention: <family>-<version>[-<variant>]
                Examples:
                - Linux: rhel-9, ubuntu-22.04, fedora-39, centos-stream-9
                - Windows: windows-server-2022, windows-11, windows-10
                - BSD: freebsd-14
                
                Providers map this to their image catalog:
                - KubeVirt: Container image or DataVolume
                - VMware: VM template or content library item
                - OpenStack: Glance image
                - AWS: AMI ID
                - Azure: Image reference
              example: "rhel-9"

            family:
              type: string
              description: |
                OS family for provider hints (optional).
                Helps providers select appropriate defaults.
              enum: [ "linux", "windows", "bsd", "other" ]
              default: "linux"

            architecture:
              type: string
              description: CPU architecture
              enum: [ "x86_64", "aarch64", "ppc64le", "s390x", "amd64" ]
              default: "x86_64"

            firmware:
              type: string
              description: |
                Firmware type.
                - bios: Traditional BIOS (broad compatibility)
                - uefi: UEFI firmware (required for modern OS, Secure Boot)
              enum: [ "bios", "uefi", "uefi-secure-boot" ]
              default: "bios"
        # ======================================================================
        # Initialization & Configuration
        # Based on: cloud-init standard (de facto industry standard)
        # ======================================================================
        initialization:
          type: object
          description: |
            VM initialization configuration.
            Uses cloud-init, the industry-standard for VM initialization
            (supported by all major Linux distros and cloud providers).
          properties:
            hostname:
              type: string
              description: VM hostname
              pattern: "^[a-z0-9]([a-z0-9-]*[a-z0-9])?$"
              example: "web-server-01"

            cloudInit:
              type: object
              description: Cloud-init configuration
              properties:
                userData:
                  type: string
                  description: |
                    Cloud-init user-data (YAML format).
                    Standard cloud-init configuration for user setup,
                    package installation, and custom scripts.
                  example: |
                    #cloud-config
                    users:
                      - name: admin
                        sudo: ALL=(ALL) NOPASSWD:ALL
                        ssh_authorized_keys:
                          - ssh-rsa AAAAB3...

                networkConfig:
                  type: string
                  description: |
                    Cloud-init network configuration (optional).
                    Uses cloud-init network config v2 format.
                  example: |
                    version: 2
                    ethernets:
                      eth0:
                        dhcp4: true

            sshKeys:
              type: array
              description: SSH public keys for initial access
              items:
                type: string
                description: SSH public key
              example:
                - "ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQ..."
        # ======================================================================
        # Metadata & Extensibility
        # Based on: OVF ProductSection, TOSCA metadata
        # ======================================================================
        metadata:
          type: object
          description: |
            Custom metadata for extensibility.
            Allows arbitrary key-value pairs for provider-specific
            configurations or future extensions without schema changes.
          additionalProperties:
            type: string
          example:
            environment: "production"
            application: "web-frontend"
            owner: "platform-team"
            costCenter: "engineering"
        annotations:
          type: object
          description: |
            Human-readable annotations (non-functional).
            Similar to Kubernetes annotations.
          additionalProperties:
            type: string
          example:
            description: "Production web server for customer portal"
            documentation: "https://wiki.example.com/vm-templates"
        # ======================================================================
        # Provider Hints
        # ======================================================================
        providerHints:
          type: object
          description: |
            Optional provider-specific configuration hints.
            
            Allows providers to optimize resource provisioning while keeping
            the core schema provider-agnostic. Each provider can define its
            own hints structure.
            
            Common use cases:
            - VMware: Hardware version, nested virtualization, advanced settings
            - KubeVirt: Instancetype preferences, dedicated CPU, hugepages
            - AWS: Instance type hints, EBS optimization, placement groups
            - Azure: VM size hints, availability zones
            - OpenStack: Flavor hints, host aggregates
            
            Providers ignore hints they don't recognize, ensuring portability.
          additionalProperties:
            type: object
          example:
            vmware:
              vmxVersion: "17"
              nestedHV: true
              latencySensitivity: "high"
            kubevirt:
              instanceType: "u1.large"
              preference: "rhel.9"
              dedicatedCPU: true
            aws:
              instanceType: "t3.xlarge"
              ebsOptimized: true
              placementGroup: "web-tier"

    VM:
      type: object
      x-aep-resource: true
      properties:
        path:
          type: string
          description: Resource path for this VM
          example: "/api/v1/vm/123e4567-e89b-12d3-a456-426614174000"
        id:
          type: string
          description: ID of the VM
          example: "123e4567-e89b-12d3-a456-426614174000"
        name:
          type: string
          description: Name of the VM
          example: "webserver"
        namespace:
          type: string
          description: Namespace of the VM
        Status:
          type: string
          description: The status of the created VM
    VMInstance:
      type: object
      x-aep-resource: true
      description: VM instance information including status, IP address, and SSH connection details
      properties:
        path:
          type: string
          description: Resource path for this VM instance
          example: "/api/v1/vm/123e4567-e89b-12d3-a456-426614174000"
        requestId:
          type: string
          description: Request ID (UUID) of the VM instance
          format: uuid
          example: "123e4567-e89b-12d3-a456-426614174000"
        name:
          type: string
          description: Name of the VM instance
          example: "my-fedora-vm"
        namespace:
          type: string
          description: Kubernetes namespace where the VM is running
          example: "us-east-1"
        status:
          type: string
          description: Current status of the VM instance
          example: "Running"
        ip:
          type: string
          description: IP address of the VM instance
          format: ipv4
          example: "10.244.0.12"
        ssh:
          type: object
          description: SSH access configuration for the VM
          properties:
            enabled:
              type: boolean
              description: Whether SSH access is enabled
              example: true
            username:
              type: string
              description: SSH username for connecting to the VM
              example: "fedora"
            secretName:
              type: string
              description: Name of the Kubernetes secret containing SSH keys
              example: "my-fedora-vm-ssh"
            connectMethods:
              type: object
              description: Available methods to connect to the VM via SSH
              properties:
                clusterSSH:
                  type: string
                  description: SSH command to connect from within the cluster
                  example: "ssh fedora@10.244.0.12"
                nodePort:
                  type: object
                  description: NodePort configuration for external SSH access
                  properties:
                    node:
                      type: string
                      description: Node IP address or hostname
                      example: "192.168.0.10"
                    port:
                      type: integer
                      description: NodePort number for SSH access
                      example: 32222

    Error:
      required:
        - error
      type: object
      properties:
        type:
          type: string
          description: Error type identifier
          format: uri-reference
          example: "https://example.com/errors/invalid-argument"
        error:
          type: string
          description: Error message
        code:
          type: integer
          description: Error code
          example: 400
